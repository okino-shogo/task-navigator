# タスクナビゲーター 要件定義書

## 📱 製品概要

**タスクナビゲーター**は、ADHDの人が抱える以下の課題を解決するiOSアプリです：

- 🧠 **記憶の課題** - タスクや予定を忘れてしまう
- 😫 **めんどくささ** - 複雑な操作や設定が苦手
- 🚧 **実行のハードル** - タスクを始めることが困難

### 🎯 コアバリュー
「最も使いやすいスケジュール管理」を実現し、音声ナビゲーション機能により画面を見ずにタスクを進行できます。

---

## 🛠 技術スタック

### バックエンド
- **データベース**: Supabase
- **MCP統合**: [Serena](https://github.com/oraios/serena)
  - プロジェクトの構造をセマンティックに分析
  - コードの意味を理解した検索や編集を可能にする

### 開発環境
- **開発支援**: SuperClaude - Claude（AI）を10倍便利にする拡張ツール
  - コード自動生成
  - バグ自動修正
  - 設計書自動作成
  - その他めんどくさい作業全般

### UIコンポーネント
- **カレンダー**: [CalendarKit](https://github.com/richardtop/CalendarKit)
  - ⚠️ **注意**: 型衝突エラーが発生する可能性があるため、実装時は注意が必要
  - CalendarKitを拡張してカスタマイズ

---

## 🎨 UI構成

### 4タブ構成

#### 1️⃣ チャット画面（ホーム）
- **役割**: メインの入力インターフェース
- **機能**:
  - 自然言語でのタスク登録
  - タスクの自動分解
  - 仮置き機能

#### 2️⃣ タイムライン画面
- **コンポーネント**: CalendarKit の `DayView` を採用（週表示は将来拡張）
- **レイアウト**: Appleカレンダー風の時間軸（日表示）
- **編集方針**: MVPはタップ/ロングプレスで詳細シート編集。ドラッグ移動は拡張で段階導入（15分スナップ）
- **ズーム**: MVPは固定スケール（30分スロット）。段階ズームは拡張検討（ピンチは競合回避のため保留）

#### 3️⃣ 実行順リスト画面
- **目的**: 実行に最適化された順序でタスクを表示
- **特徴**: 優先度と時間を考慮した並び順

#### 4️⃣ アカウント設定画面
- **機能**:
  - アカウント管理
  - 外部サービス連携設定
  - 既定動作のカスタマイズ

### ナビゲーション仕様
- **位置**: 画面下部
- **状態保持**: 各タブごとに以下を保持
  - スクロール位置
  - フィルタ設定
- **バッジ表示**: 未処理件数（例：仮置きタスク数）
- **設計方針**:
  - 深い画面遷移は最小限
  - その場編集を徹底

### 2.3 画面詳細仕様

| 画面名 | モジュール名 | 機能説明 |
| --- | --- | --- |
| チャット画面（ホーム） | 自然言語入力欄 | 日時/所要時間/場所/人をスマートパース、音声入力対応、例：「明日9時に書類準備30分」 |
| チャット画面（ホーム） | 会話中編集 | 分解提案やフィールド編集をインラインで実施 |
| チャット画面（ホーム） | 提案チップ | 「分解する」「所要30→45分」「重要マーク」「明日に送る」 |
| チャット画面（ホーム） | 仮置きボックス | 思い出した瞬間に名称だけ素早く登録→後でスケジュールへ昇格、ADHDの忘却対策として最短操作優先 |
| チャット画面（ホーム） | 通常追加ボタン | チャット以外の従来型追加方法も併設 |
| チャット画面（ホーム） | タスクテンプレート | 最近使ったタスクテンプレートの表示・再利用 |
| タイムライン画面 | 日付ピッカー | 今日ボタン付き、日付選択機能 |
| タイムライン画面 | 時間スケール | MVP: 固定スロット（30分）。拡張: 段階ズーム（0.85x/1.0x/1.15x 等） |
| タイムライン画面 | タスクブロック | 所要時間に比例した高さ。外部予定はread-only別色表示（編集不可） |
| タイムライン画面 | 空き時間表示 | MVP: 非表示/最小限（次の空きまでをヘッダーに表示）。拡張: 背景テキストや淡色帯 |
| タイムライン画面 | 生成/編集 | ロングプレスで新規作成、タップで詳細シート（タイトル/開始/所要時間/場所/人） |
| タイムライン画面 | ドラッグ操作 | 拡張: 長押し→移動（15分スナップ）。MVPではシート編集で時間変更 |
| タイムライン画面 | 衝突検知 | 「超過＋◯分」バッジをブロックに重ねて表示、修正案（分割/遅延/別日）提示 |
| タイムライン画面 | Nowインジケータ | 現在時刻ラインの常時表示、今日へジャンプ |
| タイムライン画面 | シームレス遷移 | 二本指上スワイプ or 右上トグルで実行順リストへ（ピンチアウトは保留） |
| タイムライン画面 | スクロール保持 | タブ復帰時にスクロール位置/選択日を保持 |
| タイムライン画面 | アクセシビリティ | VoiceOverラベル、コントラスト、太字、動作削減に配慮 |

#### タイムライン設計（MVPと拡張）

- **MVP（Phase 2）**
  - CalendarKit `DayView` による日表示
  - 固定スロット（30分）、現在時刻ライン、今日ボタン
  - ロングプレスで新規イベント、タップで詳細シート編集（その場編集はシートで代替）
  - 外部予定は読み取り専用表示（別色）、編集不可
  - 衝突検知はイベント取得時に計算し、ブロック上に「超過＋◯分」バッジを重ね表示
  - スクロール/選択日の状態保持

- **拡張（Phase 2.5+）**
  - 長押し→ドラッグ移動（15分スナップ、隣接との吸着）
  - 段階ズーム（0.85x/1.0x/1.15x 等）。ピンチは他操作と競合のため優先度低
  - 空き時間の背景帯・挿入アフォーダンス（＋）
  - 衝突時の修正案パネル（分割/遅延/別日へ）のクイック適用
  - 週表示（WeekView相当）への切り替え、パフォーマンス最適化

備考: CalendarKitの基本仕様（`EventDataSource`/`EventDescriptor`/`DayViewDelegate`）に準拠し実装することで、標準的なAppleカレンダー風の操作感を確保する [参考: CalendarKit README](https://github.com/richardtop/CalendarKit)。

#### サブタスクのタイムライン表現（重要）

- **設計原則**
  - タイムラインには「実行単位（葉）」のみ表示する。親タスクは実行順リストで構造を管理。
  - サブタスクは独立した `EventDescriptor` 1件としてマッピングし、`userInfo` 等に `parentTaskId` / `subtaskIndex` を付与して親子関係を保持（UIはフラット、論理は階層）。

- **表示仕様（MVP）**
  - `event.text`:
    - 1行目: サブタスク名
    - 2行目: 親タスク名またはカテゴリ（アイコン/チップ）
    - 3行目: 時刻帯（`HH:mm - HH:mm`）
  - 色/スタイル:
    - 左サイドの色バー = 親カテゴリ色（グルーピングの視覚手掛かり）
    - 背景色 = 状態（通常/重要/完了済）に応じて濃淡
  - 最小表示高: 視認性確保のためタイムライン上の最小高さは20pt前後まで引き伸ばし（実データの所要時間は不変）。
  - Nowライン、今日ボタン、スクロール保持はタイムライン共通仕様に準拠。

- **操作仕様**
  - 選択: タップでサブタスク詳細シート（タイトル/開始/所要時間/場所/人/親タスク）
  - 生成: ロングプレスで新規サブタスク（既定は選択中の親に紐付け。未指定時は単独タスクとして作成→後から親付け可）
  - 変更: MVPは詳細シートで開始/所要を編集。拡張で長押し→ドラッグ移動（15分スナップ）
  - 親跨ぎ: ドラッグ先が別親領域（拡張UI）なら「親変更/複製/分割」を確認（実行順リストの分割ポリシーと整合）

- **衝突検知/修正**
  - 単位はサブタスク（Event）で判定。外部予定や他サブタスクとの重なりを検知し、「超過＋◯分」バッジをブロックに重ね表示。
  - 修正案（分割/遅延/別日）はシートのクイックアクションで提示（拡張）。

- **通知/音声ナビ連携**
  - 直前通知はサブタスク開始直前に発火。
  - 音声ナビはサブタスク境界で案内し、スキップ操作は次サブタスク/次タスクへ遷移。

- **データマッピング指針**
  - タイムラインに供給するイベント集合 = 「親無しタスク（葉）」+「親ありサブタスク（葉）」のうち、開始時刻が確定しているもの。
  - `EventDescriptor.userInfo` に `taskId` / `parentTaskId` / `subtaskIndex` / `status` を格納し、`DayViewDelegate` の各フックで利用。
  - 階層表現が必要な場合は、拡張としてオーバーレイレイヤーを用意し、連続するサブタスク間を左端の点線レールで連結（MVPでは未実装）。

- **MVP と拡張の境界**
  - MVP: フラット表示 + 詳細シート編集 + 親カテゴリ色バー + 衝突バッジ + 通知/ナビ連携
t  - 拡張: ドラッグ移動/吸着、段階ズーム、連結レール描画、親見出しドラッグで子の一括移動、分割ウィザード

備考: CalendarKit は標準で階層イベントを持たないため、視覚的なグルーピングは色・ラベル・（拡張の）オーバーレイで表現する。[参考: CalendarKit](https://github.com/richardtop/CalendarKit)

#### 親集約表示モード（サブタスクリスト内包）

- **目的**: 親タスクの時間ブロック内にサブタスク名をできるだけ表示し、収まらない分は収納。最低でも「次にやるサブタスク」を表示する。

- **表示ルール（MVP）**
  - 1行目は必ず「次にやるサブタスク」を表示（強調色またはピル）。
  - 2行目以降は縦方向の残り高さに収まる分だけ上から順に表示。
  - 収まりきらない場合は右下に `+N` ピル（非表示件数）を表示。
  - 高さが不足する場合でも、最低1行（次サブタスク）は常に確保するため、フォントサイズと行間を最小プリセットへ縮退。

- **決定ロジック**
  - 「次にやるサブタスク」= 現在時刻以降で未完了の最小インデックス、または未スケジュール時は並び順の先頭。
  - 表示順序 = 次サブタスク → 以降のサブタスク →（余裕があれば）完了済の直後1件。
  - 最大表示行数 = `floor((eventHeight - contentInsets) / lineHeight)`（下限1）。

- **実装ガイド（CalendarKit）**
  - MVP: `EventDescriptor.text` を複数行に整形（先頭行=次サブタスク、末尾に `+N` 文字列）。`lineBreakMode = .byTruncatingTail`。
  - 拡張: `EventView` のコンテンツを差し替え（カスタムビューに `UIStackView` で行数制御、`+N` は `UILabel`/`UIButton` ピル）。
  - レイアウト確定後に `eventView.bounds.height` とフォントメトリクスから表示行数を再計算して反映（拡張）。

- **操作**
  - タップ: 詳細シートを開く（サブタスク一覧・展開/折りたたみトグル、`+N`タップで一覧へ）。
  - 長押し（拡張）: 親集約 ←→ サブタスク個別ブロック表示を切替（同一時間帯内に分割してリレンダリング）。

- **互換性**
  - 既存の「フラット（葉のみ）表示」と併存可能。設定またはタスク単位で表示モード選択。
  - 実行順リストとの整合: 次サブタスクの定義を共通モジュールで提供し、両画面で同一ロジックを利用。

備考: MVPではカスタムビューを避け、テキスト整形で目的を満たす。将来的に `EventView` 差し替えで表現力を高める。[参考: CalendarKit](https://github.com/richardtop/CalendarKit)
| 実行順リスト画面 | 固定ヘッダー | 「今→次のタスクまで◯分」「本日残り合計◯時間◯分」 |
| 実行順リスト画面 | 親見出し | 名前＋カテゴリ色バー（数値は常時非表示） |
| 実行順リスト画面 | サブタスク行 | コンパクト表示、階層構造 |
| 実行順リスト画面 | 空き時間行 | 左端点線レール、背景帯（alpha≈0.04）、右端＋ボタン |
| 実行順リスト画面 | 自動ソート | 時間順、「今＋次の2件」全展開→「他7件を表示」で段階開閉 |
| 実行順リスト画面 | 完了済み集約 | 末尾に「完了n件」（展開可・Undo 5秒） |
| 実行順リスト画面 | インライン編集 | 長押し0.25-0.35秒→ドラッグ並び替え、差し込みライン表示 |
| 実行順リスト画面 | スワイプアクション | 右=完了、左=スヌーズ（+15/+30/明日） |
| 実行順リスト画面 | 複数選択 | 後ろへ送る/明日へ送る/見積+5,+10/重要マーク |
| 実行順リスト画面 | 時間再計算 | 並び替え時の開始時刻再計算、空き時間再生成 |
| 実行順リスト画面 | 詳細編集操作 | 長押し0.25-0.35秒→ドラッグ並び替え、軽いバイブ、差し込みライン表示 |
| 実行順リスト画面 | 親タスク操作 | 見出し上へドロップ=付け替え、別親間=分割確認トースト |
| 実行順リスト画面 | 複数選択操作 | 長押し選択開始→タップ追加→下部トレーアクション |
| 実行順リスト画面 | 編集UI自動終了 | 無操作4秒で編集UIフェードアウト |
| 実行順リスト画面 | 学習機能 | 実行後の完了時間をデータベース保存、スキップ時刻記録、直近実績優先表示 |
| 実行順リスト画面 | サブタスク学習 | 直近でユーザーが編集した構成を再提示（AI案≠正解のため） |
| 実行順リスト画面 | テンプレ化 | ユーザーがタスクをロックした場合、毎回同じ所要時間で扱う |
| 音声ナビ画面 | ガイダンス再生 | 各サブタスクに紐づくガイダンスをシームレス再生 |
| 音声ナビ画面 | ロック画面表示 | 現在タスク名（サブタスクがあればサブタスク）を楽曲タイトル風に表示 |
| 音声ナビ画面 | 進行同期 | 再生時間とサブタスク見積を同期し、進行率/残り時間を推定 |
| 音声ナビ画面 | スキップ機能 | イヤホン/ロック画面のスキップで次サブタスク/次タスクへ移動 |
| 音声ナビ画面 | 実績記録 | スキップ時刻を実績時間として記録（学習用） |
| 音声ナビ画面 | 直前通知 | 開始直前に追加通知（ミス忘れ防止） |
| 音声ナビ画面 | バックグラウンド継続 | 他アプリ使用中も音声案内継続 |
| アカウント設定画面 | アカウント管理 | ログイン/ログアウト、バックアップ/エクスポート |
| アカウント設定画面 | 外部連携 | Apple/Googleカレンダー接続（読み取り専用）、編集ポリシー設定、将来の双方向同期拡張ポイント |
| アカウント設定画面 | 衝突管理 | 固定予定取り込み、衝突可視化、超過時の修正案提示（分割/遅延/別日移動） |
| アカウント設定画面 | 通知設定 | 直前通知（ユーザー設定可能時刻）、開始通知、スヌーズ（+15/+30/明日）、バックグラウンド音声リマインド |
| アカウント設定画面 | 時間計算設定 | ドラッグスナップ（15分）、最小空き（10分）、丸め（5分） |
| アカウント設定画面 | 音声ナビ設定 | バックグラウンド再生、ロック画面表示、イヤホン操作 |
| アカウント設定画面 | アクセシビリティ | 文字サイズ、コントラスト、触覚、VoiceOverラベル |
| アカウント設定画面 | プライバシー設定 | データ保持期間、音声ログのオン/オフ、同意管理 |

---

## ⚙️ コア機能

### 🎙 音声ナビゲーション
- ナビアプリのような音声ガイダンス
- 画面を見ずにタスク進行可能
- ハンズフリー操作対応

### 📅 タスク管理
- **タスク構造**:
  - 開始時刻
  - 所要時間（固定値）
- **並び替え機能**:
  - 開始時刻のみ再計算
  - 所要時間は維持

### 🔄 カレンダー連携
- 外部カレンダーとの同期
- 予定の衝突検知
- 自動修正案の提示

---

## 📖 用語定義

### 固定
- **定義**: ユーザーが入力またはテンプレート化した所要時間
- **特徴**: 直近実績による自動上書きをしない値
- **用途**: 予測可能なタスクの時間管理

### 直前通知
- **定義**: タスク開始直前の追加通知
- **包含**: 「直前知らせ」機能を含む
- **目的**: 実行忘れ防止

---

## 🎯 UX設計原則

### 主要目標
1. **記憶負担の軽減** - 覚えておく必要を最小化
2. **操作の簡素化** - 直感的で簡単な操作
3. **実行支援の強化** - タスク開始のハードルを下げる

### インタラクション設計
- ✅ インライン編集を優先
- ✅ モーダルウィンドウの使用は最小限
- ✅ 音声ナビゲーション対応
- ✅ ワンタップアクション重視

---

## 🚀 実装優先順位

1. **Phase 1**: 基本機能
   - Supabaseのセットアップ
   - 基本的なタスク管理機能
   - 4タブナビゲーション

2. **Phase 2**: カレンダー統合
   - CalendarKitの実装
   - 外部カレンダー連携

3. **Phase 3**: 高度な機能
   - 音声ナビゲーション
   - 自動スケジューリング
   - 衝突検知と修正案

---

---

## 3. コアプロセス

### メインユーザーフロー

1. ユーザーがアプリを開くとチャット画面（ホーム）で自然言語入力
2. 例：「明日9時 書類準備30分」→ Task(title=書類準備, 2025-08-13 09:00, 30m) を生成
3. AIがタスク分解提案（編集可）を提示し、確定で保存
4. タイムライン画面で時間軸レイアウトを確認・調整
5. 実行順リスト画面で最適化された順序で実行
6. 音声ナビ機能でバックグラウンド音声ガイダンスを開始
7. 外部カレンダーとの衝突時は「超過＋◯分」バッジと修正案を提示

### チャット入力フロー

1. 自然言語入力 → スマートパース → 提案チップ表示 → 確定またはタスク分解 → 保存

### タイムライン操作フロー

1. ブロックドラッグ（15分スナップ） → 開始時刻再計算 → 空き時間再生成 → 衝突チェック

### 実行順リスト操作フロー

1. 長押し0.25-0.35秒 → ドラッグ並び替え → 差し込みライン表示 → 時間再計算
2. スワイプアクション：右=完了、左=スヌーズ（+15/+30/明日）
3. 複数選択：長押し選択開始 → タップ追加 → 下部トレーアクション（後ろへ送る/明日へ送る/見積+5,+10/重要マーク）
4. 親タスク操作：見出し上へドロップ=付け替え、別親間=「親を分割しますか？」確認
5. 無操作4秒で編集UIフェードアウト

### 時間再計算アルゴリズム（並び替え確定時）

1. リスト上から順に処理
2. 開始時刻 = 直前タスクの終了時刻 + "意図した間隔"（既定間隔保持、無ければ0分）
3. 終了時刻 = 開始時刻 + 所要時間（固定）
4. 全更新後、空き時間再生成：隣接ペアの差分→10分未満は破棄→隣接Gap合算→5分単位へ丸め
5. ヘッダーの「次のタスクまで」も即時再計算
6. 外部カレンダー衝突時：「超過＋◯分」バッジ表示、修正案提示（分割/後ろへ送る/別日に移す）

### 並び替え例

- **並び替え前**：09:00 朝食準備（25分） → 空き15分 → 09:40 メールチェック（20分）
- **並び替え後**：09:00 メールチェック（20分） → 空き10分 → 09:30 朝食準備（25分）

### 音声ナビフロー

1. 実行順リスト画面で音声ナビ開始ボタンをタップ
2. 各サブタスクのガイダンスをシームレス再生
3. ロック画面に現在タスク名を楽曲タイトル風に表示
4. 再生時間とサブタスク見積を同期し、進行率/残り時間を推定
5. イヤホン/ロック画面のスキップで次サブタスク/次タスクへ移動
6. スキップ時刻を実績時間として記録（学習用）
7. 開始直前に追加通知（ミス忘れ防止）
8. 他アプリ使用中もバックグラウンドで音声案内継続

### 学習/最適化ロジック（直近主義）

1. 実行後は実際の完了時間をデータベースへ保存
2. スキップ時はそのスキップ時刻を完了として記録
3. 次回同一タスクでは、AI予測よりも直近の実績時間を優先表示
4. サブタスクも直近でユーザーが編集した構成を再提示（AI案≠正解のため）
5. 平均値は使わない理由：
    - ハプニングで外れ値が平均を歪ませる
    - 習慣化で徐々に短縮する動きを平均が捉えにくい
6. 例外：ユーザーがタスクをロックした場合、毎回同じ所要時間で扱う（テンプレ化）

### 外部カレンダー連携フロー

1. 読み取り専用で固定予定を取り込み、衝突を可視化
2. 超過時は「超過＋◯分」バッジと修正案（分割/遅延/別日移動）を提示
3. 将来的な双方向同期（Google/Apple）を見据えた拡張ポイントを用意

### 通知フロー

1. 直前通知：開始直前に追加通知（時刻はユーザー設定可能）
2. 開始通知：開始時刻に確定通知
3. スヌーズ：+15 / +30 / 明日
4. バックグラウンド音声が有効の場合は、音声での直前リマインドも実施

---

## 📝 開発メモ

- Serena MCPを使用してコードベースのセマンティック分析と編集を効率化
- SuperClaudeでAI支援による開発作業の自動化
- CalendarKitの型衝突に注意しながら実装
- ADHDユーザーのフィードバックを重視

### コンカレンシー/型衝突の実装注意点（頻出エラー対策）

- **Swift Concurrency の `Task` と自前 `Task` 構造体の衝突**
  - 症状: 「Trailing closure passed to parameter of type 'any Decoder' that does not accept a closure」
  - 原因: `Task { ... }` が自前 `struct Task` と解釈されるため
  - 対策: 非同期起動は必ず `_Concurrency.Task { ... }` を使用する

- **`@MainActor` 分離イニシャライザの呼び出し**
  - 症状: 「Call to main actor-isolated initializer in a synchronous nonisolated context」
  - 対策: デフォルト引数でのインスタンス化を避け、`init` 本体内で生成する（例: `self.service = service ?? Service()`）

- **外部からの UI/状態更新**
  - 原則: UI関連の状態更新は `@MainActor` 上で行う。バックグラウンドで値が届く場合は `_Concurrency.Task { @MainActor in ... }`

- **命名ルール**
  - 自前モデル `Task` を参照する場所では必ずモジュール名修飾（例: `NaviNavi.Task`）。
  - 併用時は「`_Concurrency.Task` = 非同期、`NaviNavi.Task` = ドメインモデル」として書き分ける。